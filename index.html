<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Virtual Harmonium ‚Äì Real Layout</title>
<style>
  :root {
    --bg:#0f1115; --panel:#161923; --ink:#e8ecf1; --muted:#9aa4b2; --accent:#46d3a7;
    --key:#23283a; --key-on:#3a4161;
  }
  body{margin:0;background:linear-gradient(180deg,#0c0f14,#10131a);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Inter,Arial}
  header{padding:18px 22px;border-bottom:1px solid #222838;background:#0e1219;position:sticky;top:0;z-index:2}
  h1{margin:0;font-weight:700;font-size:18px}
  .wrap{max-width:980px;margin:18px auto;padding:0 16px 40px}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .card{background:var(--panel);border:1px solid #23283a;border-radius:12px;padding:14px 16px;flex:1}
  .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  button{
    background:#1b2133;border:1px solid #2a324f;color:var(--ink);
    padding:8px 12px;border-radius:10px;font-weight:600;cursor:pointer
  }
  button.toggle[aria-pressed="true"]{background:var(--accent);border-color:#7df1ce;color:#0c1413}
  button.small{font-size:13px;padding:6px 9px}
  label{font-size:12px;color:var(--muted)}
  footer{opacity:.8;text-align:center;margin-top:10px;font-size:12px;color:#9aa4b2}
  .hint{font-size:13px;color:#b9c2d1}
  .meter{height:10px;background:#1b2133;border-radius:6px;overflow:hidden;border:1px solid #2a324f;margin-top:8px}
  .meter > div{height:100%;width:0;background:linear-gradient(90deg,#46d3a7,#84f1d2)}

  /* --- Real harmonium layout --- */
  .kb{ position:relative; width:700px; max-width:100%; height:180px; margin-top:14px; margin-bottom:10px; }
  .kb .white{
    position:absolute; bottom:0; width:56px; height:160px;
    background:#fff; border:1px solid #cfcfcf; border-radius:0 0 8px 8px;
    display:flex; align-items:flex-end; justify-content:center; color:#333; font-weight:700;
  }
  .kb .black{
    position:absolute; top:0; width:36px; height:104px;
    background:linear-gradient(#111,#222); border:1px solid #000; border-radius:0 0 6px 6px;
    z-index:2; display:flex; align-items:flex-end; justify-content:center; color:#f0f0f0; font-weight:700;
  }
  .kb .on{ outline:3px solid var(--accent); box-shadow:0 0 18px rgba(70,211,167,.6) inset; }
</style>
</head>
<body>
<header><h1>üéπ Virtual Harmonium (Real Layout)</h1></header>
<div class="wrap">
  <div class="row">
    <div class="card" style="flex:2">
      <div class="controls">
        <button id="start">Enable Audio</button>
        <button id="octDown" class="small">[ Oct‚Äì</button>
        <div id="octave" class="hint">Octave: 3</div>
        <button id="octUp" class="small">] Oct+</button>
        <button id="sustainBtn" class="toggle" aria-pressed="false">Space: Sustain</button>
        <button id="droneBtn" class="toggle" aria-pressed="false">1: Drone (Sa + Pa)</button>
        <button id="panicBtn" class="small" title="Stop all sound (0 key)">0: Panic</button>
      </div>
      <div class="hint" style="margin-top:8px">
        White keys: Z X C V B N M , . / &nbsp; | &nbsp; Black keys: S D G H J
      </div>

      <div id="kb" class="kb" aria-label="keyboard"></div>
      <div class="meter"><div id="vu"></div></div>
      <div class="hint">Tip: Harmonium is a free-reed instrument with a steady tone. Use the ‚ÄúChorus‚Äù & ‚ÄúVibrato‚Äù below to taste.</div>
    </div>

    <div class="card" style="flex:1;min-width:280px">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:center">
        <label>Master Volume</label><input id="gain" type="range" min="0" max="1" step="0.001" value="0.7" />
        <label>Brightness (LPF Hz)</label><input id="lpf" type="range" min="400" max="6000" step="1" value="2600" />
        <label>Chorus Depth</label><input id="chorusDepth" type="range" min="0" max="20" step="0.1" value="8" />
        <label>Chorus Rate (Hz)</label><input id="chorusRate" type="range" min="0.05" max="1.5" step="0.01" value="0.35" />
        <label>Vibrato Depth (cents)</label><input id="vibDepth" type="range" min="0" max="30" step="0.5" value="6" />
        <label>Vibrato Rate (Hz)</label><input id="vibRate" type="range" min="3" max="9" step="0.1" value="5.8" />
        <label>Key Click</label><input id="clickAmt" type="range" min="0" max="1" step="0.01" value="0.18" />
        <label>Attack (ms)</label><input id="attack" type="range" min="0" max="60" step="1" value="8" />
      </div>
    </div>
  </div>
  <footer>Made with Web Audio API. Works offline after first load.</footer>
</div>

<script>
(() => {
  // ---------- Audio engine ----------
  const state = { ctx:null, master:null, analyser:null, sustain:false, octave:3, active:new Map(), held:new Set(), drones:[] };
  function midiToFreq(m){return 440*Math.pow(2,(m-69)/12)}

  function makeVoice(freq){
    const ctx = state.ctx;
    const amp = ctx.createGain(); amp.gain.value=0;
    const lpf = ctx.createBiquadFilter(); lpf.type="lowpass"; lpf.frequency.value=Number(lpfSlider.value); lpf.Q.value=0.7;
    const formant = ctx.createBiquadFilter(); formant.type="bandpass"; formant.frequency.value=freq*2; formant.Q.value=4;
    const osc1 = ctx.createOscillator(); osc1.type="sawtooth"; osc1.frequency.value=freq*0.999;
    const osc2 = ctx.createOscillator(); osc2.type="square";   osc2.frequency.value=freq*1.001;

    const chorusLFO = ctx.createOscillator(); chorusLFO.frequency.value=Number(chorusRate.value);
    const chorusDepthGain = ctx.createGain(); chorusDepthGain.gain.value=freq*(Math.pow(2,Number(chorusDepth.value)/1200)-1);
    chorusLFO.connect(chorusDepthGain);
    chorusDepthGain.connect(osc1.frequency);
    chorusDepthGain.connect(osc2.frequency);

    const vibLFO = ctx.createOscillator(); vibLFO.frequency.value=Number(vibRate.value);
    const vibDepthGain = ctx.createGain(); vibDepthGain.gain.value=freq*(Math.pow(2,Number(vibDepth.value)/1200)-1);
    vibLFO.connect(vibDepthGain);
    vibDepthGain.connect(osc1.frequency);
    vibDepthGain.connect(osc2.frequency);

    osc1.connect(formant);
    osc2.connect(formant);
    formant.connect(lpf);
    lpf.connect(amp);
    amp.connect(state.master);

    const now = ctx.currentTime;
    const atk = Number(attack.value)/1000;
    amp.gain.setValueAtTime(0, now);
    amp.gain.linearRampToValueAtTime(1, now+atk);

    osc1.start(); osc2.start(); chorusLFO.start(); vibLFO.start();

    const stop = (releaseMs=30)=>{
      const t = ctx.currentTime;
      amp.gain.setTargetAtTime(0, t, releaseMs/1000);
      setTimeout(()=>{
        osc1.stop(); osc2.stop(); chorusLFO.stop(); vibLFO.stop();
      }, releaseMs+100);
    };
    return {freq,amp,stop,setBrightness(v){lpf.frequency.setTargetAtTime(v,ctx.currentTime,0.02)}};
  }

  function initAudio(){
    if (state.ctx) return;
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const master=ctx.createGain(); master.gain.value=Number(gain.value);
    const analyser=ctx.createAnalyser(); analyser.fftSize=512;
    master.connect(analyser).connect(ctx.destination);
    state.ctx=ctx; state.master=master; state.analyser=analyser;
    animateVU();
  }
  function animateVU(){
    const data=new Uint8Array(state.analyser.frequencyBinCount); const vu=document.getElementById('vu');
    function loop(){state.analyser.getByteFrequencyData(data); let s=0;for(const x of data)s+=x;vu.style.width=Math.min(100,(s/data.length))+'%';requestAnimationFrame(loop);}
    requestAnimationFrame(loop);
  }

  // ---------- Real keyboard layout ----------
  const kb=document.getElementById('kb');
  const WHITE_KEYS=['z','x','c','v','b','n','m',',','.','/'];
  const BLACK_KEYS={0:'s',1:'d',3:'g',4:'h',5:'j'};
  const WHITE_TO_SEMI=[0,2,4,5,7,9,11,12,14,16];
  const BLACK_POS_TO_SEMI={0:1,1:3,3:6,4:8,5:10};
  const keyToSemi=new Map();

  (function buildKeys(){
    const W=56,BW=36;
    for(let i=0;i<WHITE_KEYS.length;i++){
      const el=document.createElement('div');
      el.className='white'; el.style.left=(i*W)+'px';
      el.dataset.semi=WHITE_TO_SEMI[i];
      el.textContent=WHITE_KEYS[i].toUpperCase();
      kb.appendChild(el);
      keyToSemi.set(WHITE_KEYS[i],WHITE_TO_SEMI[i]);

      if(BLACK_KEYS[i]){
        const b=document.createElement('div');
        b.className='black';
        b.style.left=(i*W + W - BW/2)+'px';
        b.dataset.semi=BLACK_POS_TO_SEMI[i];
        b.textContent=BLACK_KEYS[i].toUpperCase();
        kb.appendChild(b);
        keyToSemi.set(BLACK_KEYS[i],BLACK_POS_TO_SEMI[i]);
      }
    }
    kb.addEventListener('mousedown',e=>{
      const k=e.target.closest('.white,.black'); if(!k)return;
      noteOnSemi(Number(k.dataset.semi)); k.classList.add('on');
    });
    kb.addEventListener('mouseup',e=>{
      const k=e.target.closest('.white,.black'); if(!k)return;
      noteOffSemi(Number(k.dataset.semi)); k.classList.remove('on');
    });
  })();

  function semiToMidi(semi){return (state.octave*12)+60+(semi-12);}
  function noteOnSemi(semi){
    initAudio();
    const midi=semiToMidi(semi); const freq=midiToFreq(midi);
    if(state.active.has(semi))return;
    const v=makeVoice(freq);
    v.setBrightness(Number(lpf.value));
    state.active.set(semi,v);
    [...kb.querySelectorAll(`[data-semi="${semi}"]`)].forEach(el=>el.classList.add('on'));
  }
  function noteOffSemi(semi){
    if(!state.active.has(semi))return;
    if(state.sustain)return;
    const v=state.active.get(semi); v.stop(35);
    state.active.delete(semi);
    [...kb.querySelectorAll(`[data-semi="${semi}"]`)].forEach(el=>el.classList.remove('on'));
  }
  function allOff(){
    for(const [semi,v] of state.active){try{v.stop(20);}catch{}}
    state.active.clear();
    kb.querySelectorAll('.on').forEach(el=>el.classList.remove('on'));
  }

  function toggleDrone(on){
    if(!state.ctx)initAudio();
    state.drones.forEach(d=>d.stop(50)); state.drones=[];
    if(!on)return;
    const sa=makeVoice(midiToFreq(semiToMidi(0)));
    const pa=makeVoice(midiToFreq(semiToMidi(7)));
    state.drones=[sa,pa];
  }

  // Keyboard input
  window.addEventListener('keydown',e=>{
    const k=e.key.toLowerCase();
    if(k===' '){e.preventDefault();state.sustain=!state.sustain;sustainBtn.setAttribute('aria-pressed',state.sustain);return;}
    if(k==='['){state.octave=Math.max(1,state.octave-1);octave.textContent='Octave: '+state.octave;return;}
    if(k===']'){state.octave=Math.min(7,state.octave+1);octave.textContent='Octave: '+state.octave;return;}
    if(k==='1'){const on=droneBtn.getAttribute('aria-pressed')!=='true';droneBtn.setAttribute('aria-pressed',on);toggleDrone(on);return;}
    if(k==='0'){allOff();toggleDrone(false);droneBtn.setAttribute('aria-pressed','false');return;}
    if(keyToSemi.has(k)&&!state.held.has(k)){state.held.add(k);noteOnSemi(keyToSemi.get(k));}
  });
  window.addEventListener('keyup',e=>{
    const k=e.key.toLowerCase();
    if(keyToSemi.has(k)){state.held.delete(k);noteOffSemi(keyToSemi.get(k));}
  });

  // Controls
  start.addEventListener('click',()=>initAudio());
  gain.addEventListener('input',e=>{if(state.master)state.master.gain.value=Number(e.target.value);});
  lpf.addEventListener('input',e=>{for(const [,v] of state.active)v.setBrightness(Number(e.target.value));});
  octDown.addEventListener('click',()=>{state.octave=Math.max(1,state.octave-1);octave.textContent='Octave: '+state.octave;});
  octUp.addEventListener('click',()=>{state.octave=Math.min(7,state.octave+1);octave.textContent='Octave: '+state.octave;});
  sustainBtn.addEventListener('click',()=>{state.sustain=!state.sustain;sustainBtn.setAttribute('aria-pressed',state.sustain);});
  droneBtn.addEventListener('click',()=>{const on=droneBtn.getAttribute('aria-pressed')!=='true';droneBtn.setAttribute('aria-pressed',on);toggleDrone(on);});
  panicBtn.addEventListener('click',()=>{allOff();toggleDrone(false);droneBtn.setAttribute('aria-pressed','false');});
})();
</script>
</body>
</html>
